jQuery(document).ready(function(e){function t(t,a="info"){let i=e("#cityride-admin-message");0===i.length&&(i=e('<div id="cityride-admin-message" class="notice is-dismissible"></div>'),e(".wrap h1").after(i)),i.removeClass("notice-info notice-warning notice-error notice-success").addClass("notice-"+a).html("<p>"+t+"</p>").fadeIn(),"info"!==a&&"success"!==a||setTimeout(()=>{i.fadeOut(()=>i.remove())},5e3)}function a(a=1){const i=e("#rides-table-body"),n=e("#rides-pagination .pagination-links"),r=e("#rides-pagination .pagination-info"),o=e("#rides-pagination .results-info"),d=e("#status-filter").val(),s=e("#date-from-filter").val(),c=e("#date-to-filter").val(),l=e("#search-filter").val(),u=e("#rides-per-page").val();i.html('<tr><td colspan="12" style="text-align: center; padding: 40px;"><div class="spinner is-active" style="float: none;"></div> Učitavanje vožnji...</td></tr>'),n.empty(),r.empty(),o.empty(),e.ajax({url:cityride_admin_ajax.ajax_url,type:"POST",data:{action:"cityride_load_rides",nonce:cityride_admin_ajax.nonce,page:a,per_page:u,status:d,date_from:s,date_to:c,search:l},success:function(a){var d;a.success?(i.html(a.data.rides_html),n.html(a.data.pagination_html),r.text(`Stranica ${a.data.current_page} od ${a.data.total_pages}`),o.text(`Ukupno vožnji: ${a.data.total_rides}`),(d=a.data.stats)?(e("#stat-today-rides").text(d.today_rides),e("#stat-this-month-rides").text(d.this_month_rides),e("#stat-monthly-revenue").text(parseFloat(d.monthly_revenue).toFixed(2)+" BAM"),e("#stat-pending-rides").text(d.pending_rides),e("#stat-assigned-rides").text(d.assigned_rides)):(console.error("Stats data is missing or invalid."),e("#stat-today-rides").text("0"),e("#stat-this-month-rides").text("0"),e("#stat-monthly-revenue").text("0.00 BAM"),e("#stat-pending-rides").text("0"),e("#stat-assigned-rides").text("0"))):(i.html('<tr><td colspan="12" style="text-align: center; padding: 40px; color: red;">Greška pri učitavanju vožnji: '+a.data+"</td></tr>"),t("Greška pri učitavanju vožnji: "+a.data,"error"))},error:function(e,a,n){i.html('<tr><td colspan="12" style="text-align: center; padding: 40px; color: red;">Greška pri povezivanju sa serverom. Status: '+a+", Greška: "+n+"</td></tr>"),t("Greška pri povezivanju sa serverom. Molimo pokušajte ponovo. Status: "+a,"error")}})}a(),setInterval(function(){a(e("#rides-pagination .pagination-link.current").data("page")||1)},15e3),e("#apply-filters").on("click",function(){a(1)}),e("#rides-per-page").on("change",function(){a(1)}),e("#clear-filters").on("click",function(){e("#status-filter").val(""),e("#date-from-filter").val(""),e("#date-to-filter").val(""),e("#search-filter").val(""),e("#rides-per-page").val("25"),a(1)}),e("#export-rides-csv").on("click",function(){const a=e("#status-filter").val(),i=e("#date-from-filter").val(),n=e("#date-to-filter").val(),r=e("#search-filter").val();t("Priprema CSV fajla...","info"),e.ajax({url:cityride_admin_ajax.ajax_url,type:"POST",data:{action:"cityride_export_rides",nonce:cityride_admin_ajax.nonce,status:a,date_from:i,date_to:n,search:r},success:function(e){if(e.success){const a=atob(e.data.data),i=e.data.filename,n=new Blob([a],{type:"text/csv;charset=utf-8;"}),r=document.createElement("a");if(void 0!==r.download){const e=URL.createObjectURL(n);r.setAttribute("href",e),r.setAttribute("download",i),r.style.visibility="hidden",document.body.appendChild(r),r.click(),document.body.removeChild(r),t("CSV fajl je uspješno generisan i preuzet.","success")}else t("Vaš preglednik ne podržava automatsko preuzimanje. Molimo kopirajte sadržaj.","warning"),window.open("data:text/csv;charset=utf-8,"+encodeURIComponent(a))}else t("Greška pri generisanju CSV fajla: "+e.data,"error")},error:function(){t("Greška pri povezivanju sa serverom za export CSV-a.","error")}})}),e("#refresh-rides").on("click",function(){a(e("#rides-pagination .pagination-link.current").data("page")||1),t("Vožnje osvježene.","info")}),e("#rides-pagination").on("click",".pagination-link",function(t){t.preventDefault();a(e(this).data("page"))});const i=e("#assign-driver-modal"),n=e("#assign-ride-id"),r=e("#driver-select"),o=e("#eta");e("#rides-table-body").on("click",".assign-driver-btn",function(){const a=e(this).data("ride-id");n.val(a),r.val(""),o.val(""),r.html('<option value="">Učitavam vozače...</option>'),e.ajax({url:cityride_admin_ajax.ajax_url,type:"POST",data:{action:"cityride_get_active_drivers",nonce:cityride_admin_ajax.nonce},success:function(e){if(e.success&&e.data.length>0){let t='<option value="">-- Odaberi vozača --</option>';e.data.forEach(function(e){t+=`<option value="${e.id}">${e.name} (${e.vehicle_number})</option>`}),r.html(t)}else r.html('<option value="">Nema aktivnih vozača</option>'),t('Trenutno nema aktivnih vozača. Molimo dodajte vozača u sekciji "Upravljanje Vozačima".',"warning")},error:function(){r.html('<option value="">Greška pri učitavanju</option>'),t("Greška pri učitavanju vozača.","error")}}),i.fadeIn()}),i.find(".close, .cancel-modal").on("click",function(){i.fadeOut()}),e("#assign-driver-form").on("submit",function(d){d.preventDefault();const s=n.val(),c=r.val(),l=o.val().trim();if(!c||!l)return void t("Molimo odaberite vozača i unesite ETA.","warning");const u=e(this).find('button[type="submit"]');u.prop("disabled",!0).text("Dodjeljujem..."),e.ajax({url:cityride_admin_ajax.ajax_url,type:"POST",data:{action:"cityride_assign_driver",nonce:cityride_admin_ajax.nonce,ride_id:s,driver_id:c,eta:l},success:function(e){e.success?(t(e.data,"success"),i.fadeOut(),a()):t("Greška pri dodjeli vozača: "+e.data,"error")},error:function(){t("Greška pri povezivanju sa serverom za dodjelu vozača.","error")},complete:function(){u.prop("disabled",!1).text("Dodijeli")}})}),e("#rides-table-body").on("click",".complete-ride-btn",function(){const i=e(this).data("ride-id");if(confirm("Jeste li sigurni da želite označiti ovu vožnju kao završenu?")){const n=e(this);n.prop("disabled",!0).text("Završavam..."),e.ajax({url:cityride_admin_ajax.ajax_url,type:"POST",data:{action:"cityride_complete_ride",nonce:cityride_admin_ajax.nonce,ride_id:i},success:function(e){e.success?(t(e.data,"success"),a()):t("Greška pri završetku vožnje: "+e.data,"error")},error:function(){t("Greška pri povezivanju sa serverom za završetak vožnje.","error")},complete:function(){n.prop("disabled",!1).text("Završi")}})}}),e("#test-webhook-btn").on("click",function(){const a=e(this);a.prop("disabled",!0).text("Testiram..."),t("Slanje testnog webhooka...","info"),e.ajax({url:cityride_admin_ajax.ajax_url,type:"POST",data:{action:"cityride_test_webhook",nonce:cityride_admin_ajax.nonce},success:function(e){e.success?t("Webhook test uspješan: "+e.data,"success"):t("Webhook test neuspješan: "+e.data,"error")},error:function(e,a,i){t("Greška pri povezivanju sa serverom za test webhooka. Status: "+a+", Greška: "+i,"error")},complete:function(){a.prop("disabled",!1).text("Test Webhook")}})});const d=e("#cancel-ride-modal"),s=e("#cancel-ride-id"),c=e("#cancel-reason-template"),l=e("#cancel-reason-custom"),u=e("#process-refund");function v(t,a="info",i="assign"){const n=e("cancel"===i?"#cancel-modal-message":"#modal-message"),r="success"===a?"notice-success":"error"===a?"notice-error":"warning"===a?"notice-warning":"notice-info";n.removeClass("notice-success notice-error notice-warning notice-info").addClass("notice "+r).html("<p>"+t+"</p>").show(),"success"!==a&&"info"!==a||setTimeout(()=>{n.fadeOut()},5e3)}c.on("change",function(){"other"===e(this).val()?l.show().prop("required",!0):l.hide().prop("required",!1)}),e("#rides-table-body").on("click",".cancel-ride-btn",function(){const t=e(this).data("ride-id");s.val(t),c.val("Zahtjev kupca"),l.val("").hide(),u.prop("checked",!0),e("#cancel-modal-message").empty(),d.fadeIn()}),d.find(".close, .cancel-modal").on("click",function(){d.fadeOut()}),e("#cancel-ride-form").on("submit",function(i){i.preventDefault();const n=s.val();let r=c.val();if("other"===r&&(r=l.val().trim(),!r))return void v("Molimo unesite razlog otkazivanja.","error","cancel");const o=u.is(":checked");if(!confirm(o?`Jeste li sigurni da želite otkazati ovu vožnju?\n\nRazlog: ${r}\n\nPovrat novca će biti procesuiran automatski.`:`Jeste li sigurni da želite otkazati ovu vožnju?\n\nRazlog: ${r}\n\nPovrat novca NEĆE biti procesuiran.`))return;const p=e(this).find('button[type="submit"]'),m=p.text();p.prop("disabled",!0).text("Otkazivanje..."),e.ajax({url:cityride_admin_ajax.ajax_url,type:"POST",data:{action:"cityride_cancel_ride",nonce:cityride_admin_ajax.nonce,ride_id:n,cancellation_reason:r,process_refund:o},success:function(e){e.success?(t("Vožnja uspješno otkazana. "+("refunded"===e.data.refund_status?"Povrat novca procesuiran.":"refund_failed"===e.data.refund_status?"UPOZORENJE: Povrat novca nije uspješan!":"Povrat novca nije procesuiran."),"refund_failed"===e.data.refund_status?"warning":"success"),d.fadeOut(),a()):v("Greška: "+e.data,"error","cancel")},error:function(e,t,a){v("Greška pri povezivanju sa serverom. Status: "+t,"error","cancel")},complete:function(){p.prop("disabled",!1).text(m)}})});if(e("#drivers-table-body").length>0){function p(){const a=e("#drivers-table-body");a.html('<tr><td colspan="10" style="text-align: center; padding: 40px;"><div class="spinner is-active" style="float: none;"></div> Učitavanje vozača...</td></tr>'),e.ajax({url:cityride_admin_ajax.ajax_url,type:"POST",data:{action:"cityride_load_drivers",nonce:cityride_admin_ajax.nonce},success:function(i){var n;i.success?(a.html(i.data.drivers_html),(n=i.data.stats)?(e("#stat-total-drivers").text(n.total_drivers),e("#stat-active-drivers").text(n.active_drivers),e("#stat-total-earnings").text(parseFloat(n.total_earnings).toFixed(2)+" BAM"),e("#stat-top-driver").text(n.top_driver||"N/A")):(console.error("Driver stats data is missing or invalid."),e("#stat-total-drivers").text("0"),e("#stat-active-drivers").text("0"),e("#stat-total-earnings").text("0.00 BAM"),e("#stat-top-driver").text("N/A"))):(a.html('<tr><td colspan="10" style="text-align: center; padding: 40px; color: red;">Greška pri učitavanju vozača: '+i.data+"</td></tr>"),t("Greška pri učitavanju vozača: "+i.data,"error"))},error:function(e,i,n){a.html('<tr><td colspan="10" style="text-align: center; padding: 40px; color: red;">Greška pri povezivanju sa serverom. Status: '+i+", Greška: "+n+"</td></tr>"),t("Greška pri povezivanju sa serverom. Status: "+i,"error")}})}p(),e.ajax({url:cityride_admin_ajax.ajax_url,type:"POST",data:{action:"cityride_load_drivers",nonce:cityride_admin_ajax.nonce},success:function(t){if(t.success&&t.data.drivers){const a=e("#export-driver-select");a.find("option:not(:first)").remove(),t.data.drivers.forEach(function(t){a.append(e("<option>",{value:t.id,text:t.name+" ("+t.vehicle_number+")"}))})}}}),e("#export-date-range").on("change",function(){"custom"===e(this).val()?e("#export-custom-dates, #export-custom-dates-to").show():e("#export-custom-dates, #export-custom-dates-to").hide()}),e("#driver-earnings-export-form").on("submit",function(t){t.preventDefault();const a=e("#export-driver-select").val(),i=e("#export-date-range").val(),n=e("#export-start-date").val(),r=e("#export-end-date").val();if(!a)return void alert("Molimo odaberite vozača.");if(!("custom"!==i||n&&r))return void alert("Molimo unesite početni i krajnji datum.");const o=e("<form>",{method:"POST",action:cityride_admin_ajax.ajax_url});o.append(e("<input>",{type:"hidden",name:"action",value:"cityride_export_driver_earnings"})),o.append(e("<input>",{type:"hidden",name:"nonce",value:cityride_admin_ajax.nonce})),o.append(e("<input>",{type:"hidden",name:"driver_id",value:a})),o.append(e("<input>",{type:"hidden",name:"date_range",value:i})),o.append(e("<input>",{type:"hidden",name:"start_date",value:n})),o.append(e("<input>",{type:"hidden",name:"end_date",value:r})),e("body").append(o),o.submit(),o.remove()});const f=e("#driver-modal"),j=e("#driver-form"),x=e("#driver-id"),y=e("#driver-modal-title");e("#add-driver-btn").on("click",function(){j[0].reset(),x.val(""),y.text("Dodaj Novog Vozača"),e("#driver-modal-message").empty(),f.fadeIn()}),e("#drivers-table-body").on("click",".edit-driver-btn",function(){const a=e(this).data("driver-id");y.text("Uredi Vozača"),e("#driver-modal-message").empty(),e.ajax({url:cityride_admin_ajax.ajax_url,type:"POST",data:{action:"cityride_get_driver",nonce:cityride_admin_ajax.nonce,driver_id:a},success:function(a){if(a.success){const t=a.data;x.val(t.id),e("#driver-name").val(t.name),e("#driver-phone").val(t.phone),e("#driver-vehicle-number").val(t.vehicle_number),e("#driver-vehicle-model").val(t.vehicle_model||""),e("#driver-license-number").val(t.license_number||""),e("#driver-status").val(t.status),f.fadeIn()}else t("Greška pri učitavanju podataka o vozaču: "+a.data,"error")},error:function(){t("Greška pri povezivanju sa serverom.","error")}})}),f.find(".close, .cancel-modal").on("click",function(){f.fadeOut()}),j.on("submit",function(a){a.preventDefault();const i=x.val(),n={action:"cityride_save_driver",nonce:cityride_admin_ajax.nonce,driver_id:i,name:e("#driver-name").val().trim(),phone:e("#driver-phone").val().trim(),vehicle_number:e("#driver-vehicle-number").val().trim(),vehicle_model:e("#driver-vehicle-model").val().trim(),license_number:e("#driver-license-number").val().trim(),status:e("#driver-status").val()},r=j.find('button[type="submit"]'),o=r.text();r.prop("disabled",!0).text("Spremam..."),e.ajax({url:cityride_admin_ajax.ajax_url,type:"POST",data:n,success:function(e){e.success?(t(e.data,"success"),f.fadeOut(),p()):v("Greška: "+e.data,"error","driver")},error:function(e,t,a){v("Greška pri povezivanju sa serverom. Status: "+t,"error","driver")},complete:function(){r.prop("disabled",!1).text(o)}})}),e("#drivers-table-body").on("click",".delete-driver-btn",function(){const a=e(this).data("driver-id"),i=e(this).data("driver-name");if(confirm(`Jeste li sigurni da želite obrisati vozača "${i}"?\n\nOva akcija ne može biti poništena.`)){const i=e(this);i.prop("disabled",!0),e.ajax({url:cityride_admin_ajax.ajax_url,type:"POST",data:{action:"cityride_delete_driver",nonce:cityride_admin_ajax.nonce,driver_id:a},success:function(e){e.success?(t(e.data,"success"),p()):(t("Greška pri brisanju vozača: "+e.data,"error"),i.prop("disabled",!1))},error:function(){t("Greška pri povezivanju sa serverom za brisanje vozača.","error"),i.prop("disabled",!1)}})}});const h=v;v=function(t,a="info",i="assign"){if("driver"===i){const i=e("#driver-modal-message"),n="success"===a?"notice-success":"error"===a?"notice-error":"warning"===a?"notice-warning":"notice-info";i.removeClass("notice-success notice-error notice-warning notice-info").addClass("notice "+n).html("<p>"+t+"</p>").show(),"success"!==a&&"info"!==a||setTimeout(()=>{i.fadeOut()},5e3)}else h(t,a,i)}}if(e("#discount-codes-table-body").length>0){const g=e("#discount-code-modal"),b=e("#discount-code-form"),k=e("#discount-code-id"),z=e("#discount-code-modal-title"),O=e("#discount-code-modal-message"),G=e("#discount-codes-table-body");function m(){e.ajax({url:cityride_admin_ajax.ajax_url,type:"POST",data:{action:"cityride_load_discount_codes",nonce:cityride_admin_ajax.nonce},success:function(e){e.success?function(e){if(0===e.length)return void G.html('<tr><td colspan="10" style="text-align: center; padding: 40px; color: #999;">Nema kodova popusta. Dodajte prvi kod!</td></tr>');let t="";e.forEach(function(e){const a="percent"===e.discount_type?e.discount_value+"%":e.discount_value+" BAM",i=1==e.is_active?"status-active":"status-inactive",n=1==e.is_active?"Aktivan":"Neaktivan",r=e.valid_from?new Date(e.valid_from).toLocaleDateString("bs-BA"):"-",o=e.valid_until?new Date(e.valid_until).toLocaleDateString("bs-BA"):"-";t+="<tr>",t+="<td><strong>"+e.code+"</strong></td>",t+="<td>"+("percent"===e.discount_type?"Procenat":"Fiksno")+"</td>",t+="<td>"+a+"</td>",t+="<td>"+parseFloat(e.min_order_amount).toFixed(2)+" BAM</td>",t+="<td>"+(e.usage_limit||"Neograničeno")+"</td>",t+="<td><strong>"+e.usage_count+"</strong></td>",t+="<td>"+r+"</td>",t+="<td>"+o+"</td>",t+='<td><span class="status-badge '+i+'">'+n+"</span></td>",t+="<td>",t+='<button class="button button-small edit-discount-code-btn" data-id="'+e.id+'">Uredi</button> ',t+='<button class="button button-small toggle-discount-code-btn" data-id="'+e.id+'" data-active="'+e.is_active+'">'+(1==e.is_active?"Deaktiviraj":"Aktiviraj")+"</button> ",t+='<button class="button button-small button-link-delete delete-discount-code-btn" data-id="'+e.id+'">Obriši</button>',t+="</td>",t+="</tr>"}),G.html(t)}(e.data):G.html('<tr><td colspan="10" style="text-align: center; padding: 40px; color: red;">Greška pri učitavanju kodova.</td></tr>')},error:function(){G.html('<tr><td colspan="10" style="text-align: center; padding: 40px; color: red;">Greška pri povezivanju sa serverom.</td></tr>')}})}function _(e,t){const a="success"===t?"notice-success":"notice-error";O.removeClass("notice-success notice-error").addClass(a).html("<p>"+e+"</p>").show(),"success"===t&&setTimeout(()=>{O.fadeOut()},3e3)}m(),e("#add-discount-code-btn").on("click",function(){b[0].reset(),k.val(""),z.text("Dodaj Novi Kod Popusta"),O.hide(),e("#is-active").prop("checked",!0),g.fadeIn()}),G.on("click",".edit-discount-code-btn",function(){const t=e(this).data("id");z.text("Uredi Kod Popusta"),O.hide(),e.ajax({url:cityride_admin_ajax.ajax_url,type:"POST",data:{action:"cityride_get_discount_code",nonce:cityride_admin_ajax.nonce,id:t},success:function(t){if(t.success){const a=t.data;k.val(a.id),e("#discount-code-code").val(a.code),e("#discount-type").val(a.discount_type),e("#discount-value").val(a.discount_value),e("#min-order-amount").val(a.min_order_amount),e("#max-discount-amount").val(a.max_discount_amount||""),e("#usage-limit").val(a.usage_limit||""),e("#is-active").prop("checked",1==a.is_active),e("#valid-from").val(a.valid_from?a.valid_from.replace(" ","T"):""),e("#valid-until").val(a.valid_until?a.valid_until.replace(" ","T"):""),g.fadeIn()}else alert("Greška pri učitavanju koda: "+t.data)}})}),b.on("submit",function(t){t.preventDefault();const a=e(this).serializeArray(),i={action:"cityride_save_discount_code",nonce:cityride_admin_ajax.nonce};a.forEach(function(e){i[e.name]=e.value}),i.is_active=e("#is-active").is(":checked")?"1":"0",e.ajax({url:cityride_admin_ajax.ajax_url,type:"POST",data:i,success:function(e){e.success?(_(e.data.message,"success"),setTimeout(function(){g.fadeOut(),m()},1500)):_(e.data,"error")},error:function(){_("Greška pri spremanju koda.","error")}})}),G.on("click",".delete-discount-code-btn",function(){if(!confirm("Jeste li sigurni da želite obrisati ovaj kod popusta?"))return;const t=e(this).data("id"),a=e(this);a.prop("disabled",!0),e.ajax({url:cityride_admin_ajax.ajax_url,type:"POST",data:{action:"cityride_delete_discount_code",nonce:cityride_admin_ajax.nonce,id:t},success:function(e){e.success?m():(alert("Greška: "+e.data),a.prop("disabled",!1))},error:function(){alert("Greška pri brisanju koda."),a.prop("disabled",!1)}})}),G.on("click",".toggle-discount-code-btn",function(){const t=e(this).data("id"),a=1==e(this).data("active")?0:1,i=e(this);i.prop("disabled",!0),e.ajax({url:cityride_admin_ajax.ajax_url,type:"POST",data:{action:"cityride_toggle_discount_code",nonce:cityride_admin_ajax.nonce,id:t,is_active:a},success:function(e){e.success?m():(alert("Greška: "+e.data),i.prop("disabled",!1))},error:function(){alert("Greška pri ažuriranju statusa."),i.prop("disabled",!1)}})}),g.find(".close, .modal-cancel").on("click",function(){g.fadeOut()})}});
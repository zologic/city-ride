jQuery(document).ready(function(e){let t=null,a=null,i=!1,n=null;function o(t,a="info"){let i=e("#cityride-admin-message");0===i.length&&(i=e('<div id="cityride-admin-message" class="notice is-dismissible"></div>'),e(".wrap h1").after(i)),i.removeClass("notice-info notice-warning notice-error notice-success").addClass("notice-"+a).html("<p>"+t+"</p>").fadeIn(),"info"!==a&&"success"!==a||setTimeout(()=>{i.fadeOut(()=>i.remove())},5e3)}function r(t=1){const a=e("#rides-table-body"),i=e("#rides-pagination .pagination-links"),n=e("#rides-pagination .pagination-info"),r=e("#rides-pagination .results-info"),s=e("#status-filter").val(),c=e("#date-from-filter").val(),l=e("#date-to-filter").val(),u=e("#search-filter").val(),v=e("#rides-per-page").val();a.html('<tr><td colspan="12" style="text-align: center; padding: 40px;"><div class="spinner is-active" style="float: none;"></div> U캜itavanje vo쬹ji...</td></tr>'),i.empty(),n.empty(),r.empty(),e.ajax({url:cityride_admin_ajax.ajax_url,type:"POST",data:{action:"cityride_load_rides",nonce:cityride_admin_ajax.nonce,page:t,per_page:v,status:s,date_from:c,date_to:l,search:u},success:function(e){e.success?(a.html(e.data.rides_html),i.html(e.data.pagination_html),n.text(`Stranica ${e.data.current_page} od ${e.data.total_pages}`),r.text(`Ukupno vo쬹ji: ${e.data.total_rides}`),d(e.data.stats)):(a.html('<tr><td colspan="12" style="text-align: center; padding: 40px; color: red;">Gre코ka pri u캜itavanju vo쬹ji: '+e.data+"</td></tr>"),o("Gre코ka pri u캜itavanju vo쬹ji: "+e.data,"error"))},error:function(e,t,i){a.html('<tr><td colspan="12" style="text-align: center; padding: 40px; color: red;">Gre코ka pri povezivanju sa serverom. Status: '+t+", Gre코ka: "+i+"</td></tr>"),o("Gre코ka pri povezivanju sa serverom. Molimo poku코ajte ponovo. Status: "+t,"error")}})}function d(t){t?(e("#stat-today-rides").text(t.today_rides),e("#stat-this-month-rides").text(t.this_month_rides),e("#stat-monthly-revenue").text(parseFloat(t.monthly_revenue).toFixed(2)+" BAM"),e("#stat-pending-rides").text(t.pending_rides),e("#stat-assigned-rides").text(t.assigned_rides)):(console.error("Stats data is missing or invalid."),e("#stat-today-rides").text("0"),e("#stat-this-month-rides").text("0"),e("#stat-monthly-revenue").text("0.00 BAM"),e("#stat-pending-rides").text("0"),e("#stat-assigned-rides").text("0"))}function s(){e.ajax({url:cityride_admin_ajax.ajax_url,method:"POST",data:{action:"cityride_get_ride_updates",nonce:cityride_admin_ajax.nonce,since:t,current_filters:{status:e("#status-filter").val()||"all",date_from:e("#date-from-filter").val()||"",date_to:e("#date-to-filter").val()||"",search:e("#search-filter").val()||""}},success:function(a){if(a.success&&a.data.rides.length>0){c(a.data.rides);const i=a.data.rides.filter(function(e){return"payed_unassigned"===e.status&&e.created_at>t});i.length>0&&function(t){(function(t){e(".floating-notification").remove();const a=e('<div class="floating-notification"><div class="notification-icon">游뚰</div><div class="notification-content"><strong>Nova rezervacija!</strong><p>'+t+" vo쬹ja 캜eka na dodjelu</p></div></div>");e("body").append(a),setTimeout(function(){a.fadeOut(300,function(){e(this).remove()})},5e3)})(t.length),function(){if(!cityride_admin_ajax.soundEnabled||"no"===cityride_admin_ajax.soundEnabled)return;if(cityride_admin_ajax.notificationSoundUrl){const e=new Audio(cityride_admin_ajax.notificationSoundUrl);e.volume=.5,e.play().catch(function(e){console.log("Sound playback failed:",e)})}}(),window.Notification&&"granted"===Notification.permission&&new Notification("Nova rezervacija!",{body:t.length+" nova vo쬹ja 캜eka na dodjelu",icon:cityride_admin_ajax.logoUrl||"",tag:"new-booking"});!function(t){const a=document.title;let i=!0,n=0;const o=setInterval(function(){document.title=i?"("+t+") NOVA VO콯NJA!":a,i=!i,n++,n>=10&&(clearInterval(o),document.title=a)},1e3);e(window).one("focus",function(){clearInterval(o),document.title=a})}(t.length)}(i),a.data.stats&&d(a.data.stats)}t=a.data.current_timestamp},error:function(){console.log("Auto-update check failed, will retry in 5 seconds")}})}function c(t){return i?(console.log("User typing, updates will apply after they finish"),void(window.pendingUpdates=t)):e('.ui-dialog:visible, .modal:visible, [role="dialog"]:visible').length>0?(console.log("Dialog open, updates will apply after close"),void(window.pendingUpdates=t)):(t.forEach(function(t){!function(t){const a=e('tr[data-ride-id="'+t.id+'"]');a.length>0?(n=t,(i=a).addClass("updating"),setTimeout(function(){const e=i.find("td").eq(5),t=i.find("td").eq(9),a=i.find("td").eq(10),o=i.find("td").eq(12);e.html(l(n.status)),t.text(n.cab_driver_id||"Nije dodijeljen"),a.text(n.eta||"N/A"),o.html(u(n)),i.removeClass("updating").addClass("updated"),setTimeout(function(){i.removeClass("updated")},2e3)},300)):function(t){const a=function(e){const t="status-"+e.status.replace("_","-"),a=(i=e.sms_delivery_status||"not_sent",{not_sent:"Nije poslana",pending:"Na 캜ekanju",delivered:"Dostavljena",failed:"Neuspjelo",rejected:"Odbijena",unknown:"Nepoznato"}[i]||i);var i;return'<tr data-ride-id="'+e.id+'"><td>'+e.id+"</td><td>"+v(e.address_from)+"</td><td>"+v(e.address_to)+"</td><td>"+parseFloat(e.distance_km).toFixed(2)+"</td><td>"+parseFloat(e.total_price).toFixed(2)+'</td><td class="status '+t+'">'+l(e.status)+'</td><td><span class="sms-status sms-status-'+(e.sms_delivery_status||"not_sent")+'">'+a+"</span></td><td>"+v(e.passenger_name)+"</td><td>"+v(e.passenger_phone)+"</td><td>"+(e.cab_driver_id||"Nije dodijeljen")+"</td><td>"+(e.eta||"N/A")+"</td><td>"+function(e){if(!e)return"N/A";const t=new Date(e);return t.toLocaleDateString("hr-HR")+" "+t.toLocaleTimeString("hr-HR",{hour:"2-digit",minute:"2-digit"})}(e.created_at)+"</td><td>"+u(e)+"</td></tr>"}(t);e(a).addClass("new-ride").attr("data-ride-id",t.id).hide().prependTo("#rides-table-body").slideDown(400,function(){e(this).addClass("highlight"),setTimeout(function(){e(a).removeClass("highlight")},3e3)})}(t);var i,n}(t)}),void(window.pendingUpdates=null))}function l(e){return v({payed_unassigned:"Pla캖eno - Nedodijeljeno",payed_assigned:"Dodijeljeno",completed:"Zavr코eno",cancelled:"Otkazano",no_show:"Nije se pojavio"}[e]||e)}function u(e){let t="";return"payed_unassigned"===e.status?(t+='<button class="button assign-driver-btn" data-ride-id="'+e.id+'">Dodijeli</button> ',t+='<button class="button cancel-ride-btn" data-ride-id="'+e.id+'" style="background: linear-gradient(45deg, #dc3545, #c82333); color: white; border: none;">Otka쬴</button>'):"payed_assigned"===e.status?(t+='<button class="button button-primary complete-ride-btn" data-ride-id="'+e.id+'">Zavr코i</button> ',t+='<button class="button cancel-ride-btn" data-ride-id="'+e.id+'" style="background: linear-gradient(45deg, #dc3545, #c82333); color: white; border: none;">Otka쬴</button>'):"cancelled"===e.status?(t+='<span style="color: #666; font-style: italic;">Otkazana</span>',e.cancellation_reason&&(t+='<br><small style="color: #999;">Razlog: '+v(e.cancellation_reason)+"</small>")):"no_show"===e.status&&(t+='<span style="color: #666; font-style: italic;">Nije se pojavio</span>'),t}function v(e){if(!e)return"";const t={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"};return String(e).replace(/[&<>"']/g,function(e){return t[e]})}window.pendingUpdates=null,r(),e("#rides-table-body").length>0&&(t=(new Date).toISOString(),e(document).on("keydown","input, textarea",function(){i=!0,clearTimeout(n),n=setTimeout(function(){i=!1,window.pendingUpdates&&c(window.pendingUpdates)},2e3)}),a=setInterval(s,5e3),window.Notification&&"default"===Notification.permission&&Notification.requestPermission(),console.log("Smart auto-update initialized (5-second intervals)")),e("#apply-filters").on("click",function(){r(1)}),e("#rides-per-page").on("change",function(){r(1)}),e("#clear-filters").on("click",function(){e("#status-filter").val(""),e("#date-from-filter").val(""),e("#date-to-filter").val(""),e("#search-filter").val(""),e("#rides-per-page").val("25"),r(1)}),e("#export-rides-csv").on("click",function(){const t=e("#status-filter").val(),a=e("#date-from-filter").val(),i=e("#date-to-filter").val(),n=e("#search-filter").val();o("Priprema CSV fajla...","info"),e.ajax({url:cityride_admin_ajax.ajax_url,type:"POST",data:{action:"cityride_export_rides",nonce:cityride_admin_ajax.nonce,status:t,date_from:a,date_to:i,search:n},success:function(e){if(e.success){const t=atob(e.data.data),a=e.data.filename,i=new Blob([t],{type:"text/csv;charset=utf-8;"}),n=document.createElement("a");if(void 0!==n.download){const e=URL.createObjectURL(i);n.setAttribute("href",e),n.setAttribute("download",a),n.style.visibility="hidden",document.body.appendChild(n),n.click(),document.body.removeChild(n),o("CSV fajl je uspje코no generisan i preuzet.","success")}else o("Va코 preglednik ne podr쬬va automatsko preuzimanje. Molimo kopirajte sadr쬬j.","warning"),window.open("data:text/csv;charset=utf-8,"+encodeURIComponent(t))}else o("Gre코ka pri generisanju CSV fajla: "+e.data,"error")},error:function(){o("Gre코ka pri povezivanju sa serverom za export CSV-a.","error")}})}),e("#refresh-rides").on("click",function(){r(e("#rides-pagination .pagination-link.current").data("page")||1),o("Vo쬹je osvje쬰ne.","info")}),e("#rides-pagination").on("click",".pagination-link",function(t){t.preventDefault();r(e(this).data("page"))});const p=e("#assign-driver-modal"),m=e("#assign-ride-id"),f=e("#driver-select"),_=e("#eta");e("#rides-table-body").on("click",".assign-driver-btn",function(){const t=e(this).data("ride-id");m.val(t),f.val(""),_.val(""),f.html('<option value="">U캜itavam voza캜e...</option>'),e.ajax({url:cityride_admin_ajax.ajax_url,type:"POST",data:{action:"cityride_get_active_drivers",nonce:cityride_admin_ajax.nonce},success:function(e){if(e.success&&e.data.length>0){let t='<option value="">-- Odaberi voza캜a --</option>';e.data.forEach(function(e){t+=`<option value="${e.id}">${e.name} (${e.vehicle_number})</option>`}),f.html(t)}else f.html('<option value="">Nema aktivnih voza캜a</option>'),o('Trenutno nema aktivnih voza캜a. Molimo dodajte voza캜a u sekciji "Upravljanje Voza캜ima".',"warning")},error:function(){f.html('<option value="">Gre코ka pri u캜itavanju</option>'),o("Gre코ka pri u캜itavanju voza캜a.","error")}}),p.fadeIn()}),p.find(".close, .cancel-modal").on("click",function(){p.fadeOut()}),e("#assign-driver-form").on("submit",function(t){t.preventDefault();const a=m.val(),i=f.val(),n=_.val().trim();if(!i||!n)return void o("Molimo odaberite voza캜a i unesite ETA.","warning");const d=e(this).find('button[type="submit"]');d.prop("disabled",!0).text("Dodjeljujem..."),e.ajax({url:cityride_admin_ajax.ajax_url,type:"POST",data:{action:"cityride_assign_driver",nonce:cityride_admin_ajax.nonce,ride_id:a,driver_id:i,eta:n},success:function(e){e.success?(o(e.data,"success"),p.fadeOut(),r()):o("Gre코ka pri dodjeli voza캜a: "+e.data,"error")},error:function(){o("Gre코ka pri povezivanju sa serverom za dodjelu voza캜a.","error")},complete:function(){d.prop("disabled",!1).text("Dodijeli")}})}),e("#rides-table-body").on("click",".complete-ride-btn",function(){const t=e(this).data("ride-id");if(confirm("Jeste li sigurni da 쬰lite ozna캜iti ovu vo쬹ju kao zavr코enu?")){const a=e(this);a.prop("disabled",!0).text("Zavr코avam..."),e.ajax({url:cityride_admin_ajax.ajax_url,type:"POST",data:{action:"cityride_complete_ride",nonce:cityride_admin_ajax.nonce,ride_id:t},success:function(e){e.success?(o(e.data,"success"),r()):o("Gre코ka pri zavr코etku vo쬹je: "+e.data,"error")},error:function(){o("Gre코ka pri povezivanju sa serverom za zavr코etak vo쬹je.","error")},complete:function(){a.prop("disabled",!1).text("Zavr코i")}})}}),e("#test-webhook-btn").on("click",function(){const t=e(this);t.prop("disabled",!0).text("Testiram..."),o("Slanje testnog webhooka...","info"),e.ajax({url:cityride_admin_ajax.ajax_url,type:"POST",data:{action:"cityride_test_webhook",nonce:cityride_admin_ajax.nonce},success:function(e){e.success?o("Webhook test uspje코an: "+e.data,"success"):o("Webhook test neuspje코an: "+e.data,"error")},error:function(e,t,a){o("Gre코ka pri povezivanju sa serverom za test webhooka. Status: "+t+", Gre코ka: "+a,"error")},complete:function(){t.prop("disabled",!1).text("Test Webhook")}})});const j=e("#cancel-ride-modal"),g=e("#cancel-ride-id"),y=e("#cancel-reason-template"),h=e("#cancel-reason-custom"),x=e("#process-refund");function b(t,a="info",i="assign"){const n=e("cancel"===i?"#cancel-modal-message":"#modal-message"),o="success"===a?"notice-success":"error"===a?"notice-error":"warning"===a?"notice-warning":"notice-info";n.removeClass("notice-success notice-error notice-warning notice-info").addClass("notice "+o).html("<p>"+t+"</p>").show(),"success"!==a&&"info"!==a||setTimeout(()=>{n.fadeOut()},5e3)}y.on("change",function(){"other"===e(this).val()?h.show().prop("required",!0):h.hide().prop("required",!1)}),e("#rides-table-body").on("click",".cancel-ride-btn",function(){const t=e(this).data("ride-id");g.val(t),y.val("Zahtjev kupca"),h.val("").hide(),x.prop("checked",!0),e("#cancel-modal-message").empty(),j.fadeIn()}),j.find(".close, .cancel-modal").on("click",function(){j.fadeOut()}),e("#cancel-ride-form").on("submit",function(t){t.preventDefault();const a=g.val();let i=y.val();if("other"===i&&(i=h.val().trim(),!i))return void b("Molimo unesite razlog otkazivanja.","error","cancel");const n=x.is(":checked");if(!confirm(n?`Jeste li sigurni da 쬰lite otkazati ovu vo쬹ju?\n\nRazlog: ${i}\n\nPovrat novca 캖e biti procesuiran automatski.`:`Jeste li sigurni da 쬰lite otkazati ovu vo쬹ju?\n\nRazlog: ${i}\n\nPovrat novca NE캕E biti procesuiran.`))return;const d=e(this).find('button[type="submit"]'),s=d.text();d.prop("disabled",!0).text("Otkazivanje..."),e.ajax({url:cityride_admin_ajax.ajax_url,type:"POST",data:{action:"cityride_cancel_ride",nonce:cityride_admin_ajax.nonce,ride_id:a,cancellation_reason:i,process_refund:n},success:function(e){e.success?(o("Vo쬹ja uspje코no otkazana. "+("refunded"===e.data.refund_status?"Povrat novca procesuiran.":"refund_failed"===e.data.refund_status?"UPOZORENJE: Povrat novca nije uspje코an!":"Povrat novca nije procesuiran."),"refund_failed"===e.data.refund_status?"warning":"success"),j.fadeOut(),r()):b("Gre코ka: "+e.data,"error","cancel")},error:function(e,t,a){b("Gre코ka pri povezivanju sa serverom. Status: "+t,"error","cancel")},complete:function(){d.prop("disabled",!1).text(s)}})});if(e("#drivers-table-body").length>0){function k(){const t=e("#drivers-table-body");t.html('<tr><td colspan="10" style="text-align: center; padding: 40px;"><div class="spinner is-active" style="float: none;"></div> U캜itavanje voza캜a...</td></tr>'),e.ajax({url:cityride_admin_ajax.ajax_url,type:"POST",data:{action:"cityride_load_drivers",nonce:cityride_admin_ajax.nonce},success:function(a){var i;a.success?(t.html(a.data.drivers_html),(i=a.data.stats)?(e("#stat-total-drivers").text(i.total_drivers),e("#stat-active-drivers").text(i.active_drivers),e("#stat-total-earnings").text(parseFloat(i.total_earnings).toFixed(2)+" BAM"),e("#stat-top-driver").text(i.top_driver||"N/A")):(console.error("Driver stats data is missing or invalid."),e("#stat-total-drivers").text("0"),e("#stat-active-drivers").text("0"),e("#stat-total-earnings").text("0.00 BAM"),e("#stat-top-driver").text("N/A"))):(t.html('<tr><td colspan="10" style="text-align: center; padding: 40px; color: red;">Gre코ka pri u캜itavanju voza캜a: '+a.data+"</td></tr>"),o("Gre코ka pri u캜itavanju voza캜a: "+a.data,"error"))},error:function(e,a,i){t.html('<tr><td colspan="10" style="text-align: center; padding: 40px; color: red;">Gre코ka pri povezivanju sa serverom. Status: '+a+", Gre코ka: "+i+"</td></tr>"),o("Gre코ka pri povezivanju sa serverom. Status: "+a,"error")}})}k(),e.ajax({url:cityride_admin_ajax.ajax_url,type:"POST",data:{action:"cityride_load_drivers",nonce:cityride_admin_ajax.nonce},success:function(t){if(t.success&&t.data.drivers){const a=e("#export-driver-select");a.find("option:not(:first)").remove(),t.data.drivers.forEach(function(t){a.append(e("<option>",{value:t.id,text:t.name+" ("+t.vehicle_number+")"}))})}}}),e("#export-date-range").on("change",function(){"custom"===e(this).val()?e("#export-custom-dates, #export-custom-dates-to").show():e("#export-custom-dates, #export-custom-dates-to").hide()}),e("#driver-earnings-export-form").on("submit",function(t){t.preventDefault();const a=e("#export-driver-select").val(),i=e("#export-date-range").val(),n=e("#export-start-date").val(),o=e("#export-end-date").val();if(!a)return void alert("Molimo odaberite voza캜a.");if(!("custom"!==i||n&&o))return void alert("Molimo unesite po캜etni i krajnji datum.");const r=e("<form>",{method:"POST",action:cityride_admin_ajax.ajax_url});r.append(e("<input>",{type:"hidden",name:"action",value:"cityride_export_driver_earnings"})),r.append(e("<input>",{type:"hidden",name:"nonce",value:cityride_admin_ajax.nonce})),r.append(e("<input>",{type:"hidden",name:"driver_id",value:a})),r.append(e("<input>",{type:"hidden",name:"date_range",value:i})),r.append(e("<input>",{type:"hidden",name:"start_date",value:n})),r.append(e("<input>",{type:"hidden",name:"end_date",value:o})),e("body").append(r),r.submit(),r.remove()});const O=e("#driver-modal"),S=e("#driver-form"),T=e("#driver-id"),G=e("#driver-modal-title");e("#add-driver-btn").on("click",function(){S[0].reset(),T.val(""),G.text("Dodaj Novog Voza캜a"),e("#driver-modal-message").empty(),O.fadeIn()}),e("#drivers-table-body").on("click",".edit-driver-btn",function(){const t=e(this).data("driver-id");G.text("Uredi Voza캜a"),e("#driver-modal-message").empty(),e.ajax({url:cityride_admin_ajax.ajax_url,type:"POST",data:{action:"cityride_get_driver",nonce:cityride_admin_ajax.nonce,driver_id:t},success:function(t){if(t.success){const a=t.data;T.val(a.id),e("#driver-name").val(a.name),e("#driver-phone").val(a.phone),e("#driver-vehicle-number").val(a.vehicle_number),e("#driver-vehicle-model").val(a.vehicle_model||""),e("#driver-license-number").val(a.license_number||""),e("#driver-status").val(a.status),O.fadeIn()}else o("Gre코ka pri u캜itavanju podataka o voza캜u: "+t.data,"error")},error:function(){o("Gre코ka pri povezivanju sa serverom.","error")}})}),O.find(".close, .cancel-modal").on("click",function(){O.fadeOut()}),S.on("submit",function(t){t.preventDefault();const a=T.val(),i={action:"cityride_save_driver",nonce:cityride_admin_ajax.nonce,driver_id:a,name:e("#driver-name").val().trim(),phone:e("#driver-phone").val().trim(),vehicle_number:e("#driver-vehicle-number").val().trim(),vehicle_model:e("#driver-vehicle-model").val().trim(),license_number:e("#driver-license-number").val().trim(),status:e("#driver-status").val()},n=S.find('button[type="submit"]'),r=n.text();n.prop("disabled",!0).text("Spremam..."),e.ajax({url:cityride_admin_ajax.ajax_url,type:"POST",data:i,success:function(e){e.success?(o(e.data,"success"),O.fadeOut(),k()):b("Gre코ka: "+e.data,"error","driver")},error:function(e,t,a){b("Gre코ka pri povezivanju sa serverom. Status: "+t,"error","driver")},complete:function(){n.prop("disabled",!1).text(r)}})}),e("#drivers-table-body").on("click",".delete-driver-btn",function(){const t=e(this).data("driver-id"),a=e(this).data("driver-name");if(confirm(`Jeste li sigurni da 쬰lite obrisati voza캜a "${a}"?\n\nOva akcija ne mo쬰 biti poni코tena.`)){const a=e(this);a.prop("disabled",!0),e.ajax({url:cityride_admin_ajax.ajax_url,type:"POST",data:{action:"cityride_delete_driver",nonce:cityride_admin_ajax.nonce,driver_id:t},success:function(e){e.success?(o(e.data,"success"),k()):(o("Gre코ka pri brisanju voza캜a: "+e.data,"error"),a.prop("disabled",!1))},error:function(){o("Gre코ka pri povezivanju sa serverom za brisanje voza캜a.","error"),a.prop("disabled",!1)}})}});const N=b;b=function(t,a="info",i="assign"){if("driver"===i){const i=e("#driver-modal-message"),n="success"===a?"notice-success":"error"===a?"notice-error":"warning"===a?"notice-warning":"notice-info";i.removeClass("notice-success notice-error notice-warning notice-info").addClass("notice "+n).html("<p>"+t+"</p>").show(),"success"!==a&&"info"!==a||setTimeout(()=>{i.fadeOut()},5e3)}else N(t,a,i)}}if(e("#discount-codes-table-body").length>0){const P=e("#discount-code-modal"),D=e("#discount-code-form"),A=e("#discount-code-id"),C=e("#discount-code-modal-title"),U=e("#discount-code-modal-message"),E=e("#discount-codes-table-body");function w(){e.ajax({url:cityride_admin_ajax.ajax_url,type:"POST",data:{action:"cityride_load_discount_codes",nonce:cityride_admin_ajax.nonce},success:function(e){e.success?function(e){if(0===e.length)return void E.html('<tr><td colspan="10" style="text-align: center; padding: 40px; color: #999;">Nema kodova popusta. Dodajte prvi kod!</td></tr>');let t="";e.forEach(function(e){const a="percent"===e.discount_type?e.discount_value+"%":e.discount_value+" BAM",i=1==e.is_active?"status-active":"status-inactive",n=1==e.is_active?"Aktivan":"Neaktivan",o=e.valid_from?new Date(e.valid_from).toLocaleDateString("bs-BA"):"-",r=e.valid_until?new Date(e.valid_until).toLocaleDateString("bs-BA"):"-";t+="<tr>",t+="<td><strong>"+e.code+"</strong></td>",t+="<td>"+("percent"===e.discount_type?"Procenat":"Fiksno")+"</td>",t+="<td>"+a+"</td>",t+="<td>"+parseFloat(e.min_order_amount).toFixed(2)+" BAM</td>",t+="<td>"+(e.usage_limit||"Neograni캜eno")+"</td>",t+="<td><strong>"+e.usage_count+"</strong></td>",t+="<td>"+o+"</td>",t+="<td>"+r+"</td>",t+='<td><span class="status-badge '+i+'">'+n+"</span></td>",t+="<td>",t+='<button class="button button-small edit-discount-code-btn" data-id="'+e.id+'">Uredi</button> ',t+='<button class="button button-small toggle-discount-code-btn" data-id="'+e.id+'" data-active="'+e.is_active+'">'+(1==e.is_active?"Deaktiviraj":"Aktiviraj")+"</button> ",t+='<button class="button button-small button-link-delete delete-discount-code-btn" data-id="'+e.id+'">Obri코i</button>',t+="</td>",t+="</tr>"}),E.html(t)}(e.data):E.html('<tr><td colspan="10" style="text-align: center; padding: 40px; color: red;">Gre코ka pri u캜itavanju kodova.</td></tr>')},error:function(){E.html('<tr><td colspan="10" style="text-align: center; padding: 40px; color: red;">Gre코ka pri povezivanju sa serverom.</td></tr>')}})}function z(e,t){const a="success"===t?"notice-success":"notice-error";U.removeClass("notice-success notice-error").addClass(a).html("<p>"+e+"</p>").show(),"success"===t&&setTimeout(()=>{U.fadeOut()},3e3)}w(),e("#add-discount-code-btn").on("click",function(){D[0].reset(),A.val(""),C.text("Dodaj Novi Kod Popusta"),U.hide(),e("#is-active").prop("checked",!0),P.fadeIn()}),E.on("click",".edit-discount-code-btn",function(){const t=e(this).data("id");C.text("Uredi Kod Popusta"),U.hide(),e.ajax({url:cityride_admin_ajax.ajax_url,type:"POST",data:{action:"cityride_get_discount_code",nonce:cityride_admin_ajax.nonce,id:t},success:function(t){if(t.success){const a=t.data;A.val(a.id),e("#discount-code-code").val(a.code),e("#discount-type").val(a.discount_type),e("#discount-value").val(a.discount_value),e("#min-order-amount").val(a.min_order_amount),e("#max-discount-amount").val(a.max_discount_amount||""),e("#usage-limit").val(a.usage_limit||""),e("#is-active").prop("checked",1==a.is_active),e("#valid-from").val(a.valid_from?a.valid_from.replace(" ","T"):""),e("#valid-until").val(a.valid_until?a.valid_until.replace(" ","T"):""),P.fadeIn()}else alert("Gre코ka pri u캜itavanju koda: "+t.data)}})}),D.on("submit",function(t){t.preventDefault();const a=e(this).serializeArray(),i={action:"cityride_save_discount_code",nonce:cityride_admin_ajax.nonce};a.forEach(function(e){i[e.name]=e.value}),i.is_active=e("#is-active").is(":checked")?"1":"0",e.ajax({url:cityride_admin_ajax.ajax_url,type:"POST",data:i,success:function(e){e.success?(z(e.data.message,"success"),setTimeout(function(){P.fadeOut(),w()},1500)):z(e.data,"error")},error:function(){z("Gre코ka pri spremanju koda.","error")}})}),E.on("click",".delete-discount-code-btn",function(){if(!confirm("Jeste li sigurni da 쬰lite obrisati ovaj kod popusta?"))return;const t=e(this).data("id"),a=e(this);a.prop("disabled",!0),e.ajax({url:cityride_admin_ajax.ajax_url,type:"POST",data:{action:"cityride_delete_discount_code",nonce:cityride_admin_ajax.nonce,id:t},success:function(e){e.success?w():(alert("Gre코ka: "+e.data),a.prop("disabled",!1))},error:function(){alert("Gre코ka pri brisanju koda."),a.prop("disabled",!1)}})}),E.on("click",".toggle-discount-code-btn",function(){const t=e(this).data("id"),a=1==e(this).data("active")?0:1,i=e(this);i.prop("disabled",!0),e.ajax({url:cityride_admin_ajax.ajax_url,type:"POST",data:{action:"cityride_toggle_discount_code",nonce:cityride_admin_ajax.nonce,id:t,is_active:a},success:function(e){e.success?w():(alert("Gre코ka: "+e.data),i.prop("disabled",!1))},error:function(){alert("Gre코ka pri a쬿riranju statusa."),i.prop("disabled",!1)}})}),P.find(".close, .modal-cancel").on("click",function(){P.fadeOut()})}});
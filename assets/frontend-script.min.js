jQuery(document).ready(function(e){let t,n,o,a=!1,i={},r="";"undefined"!=typeof cityride_frontend_ajax&&"string"==typeof cityride_frontend_ajax.stripe_public_key&&cityride_frontend_ajax.stripe_public_key.length>0&&(t=Stripe(cityride_frontend_ajax.stripe_public_key),n=t.elements(),o=n.create("card",{style:{base:{fontSize:"16px",color:"#424770","::placeholder":{color:"#aab7c4"}}},hidePostalCode:!0})),"undefined"!=typeof cityride_frontend_ajax&&"1"===cityride_frontend_ajax.enable_push_notifications?new Promise((e,t)=>{const n=setInterval(()=>{void 0!==window.OneSignal&&"function"==typeof window.OneSignal.isPushNotificationsEnabled&&"function"==typeof window.OneSignal.getUserId&&(clearInterval(n),console.log("frontend-script.js: OneSignal SDK je spreman i potpuno učitan."),e(window.OneSignal))},100)}).then(t=>{console.log("frontend-script.js: Pokrećem OneSignal logiku u frontend-script.js."),t.isPushNotificationsEnabled(function(n){console.log("frontend-script.js: OneSignal.isPushNotificationsEnabled status:",n),n?(console.log("frontend-script.js: Push notifikacije su omogućene u pregledniku."),t.getUserId().then(function(t){console.log("frontend-script.js: Rezultat OneSignal.getUserId().then() - userId:",t),t?(console.log("frontend-script.js: OneSignal Player ID (iz OneSignal.getUserId().then()):",t),r=t,e("#passenger_onesignal_id").val(t),console.log("frontend-script.js: Vrijednost skrivenog polja '#passenger_onesignal_id' nakon postavljanja:",e("#passenger_onesignal_id").val())):(console.warn("frontend-script.js: OneSignal Player ID nije dostupan iz getUserId() - userId je null/undefined."),e("#passenger_onesignal_id").val(""))}).catch(function(t){console.error("frontend-script.js: Greška pri dohvaćanju OneSignal Player ID-a (Promise reject):",t),e("#passenger_onesignal_id").val("")})):(console.log("frontend-script.js: Push notifikacije NISU omogućene za ovog korisnika u pregledniku."),e("#passenger_onesignal_id").val(""))}),t.on("subscriptionChange",function(n){console.log("frontend-script.js: Događaj: subscriptionChange, isSubscribed:",n),n?(console.log("frontend-script.js: Događaj: Korisnik se upravo pretplatio."),t.getUserId().then(function(t){console.log("frontend-script.js: Događaj: Novi Player ID nakon pretplate (iz subscriptionChange):",t),t&&e("#passenger_onesignal_id").val(t)})):(e("#passenger_onesignal_id").val(""),console.log("frontend-script.js: Događaj: Korisnik se odjavio sa push notifikacija."))})}).catch(t=>{console.error("frontend-script.js: Greška pri čekanju na OneSignal SDK (outer catch):",t),e("#passenger_onesignal_id").val("")}):(console.log("frontend-script.js: Push notifikacije su onemogućene u WordPress postavkama ili cityride_frontend_ajax nije definiran."),e("#passenger_onesignal_id").val("")),e("#calculate-price-btn").on("click",function(){const t=e("#address-from").val().trim(),n=e("#address-to").val().trim();if(!t||!n)return void alert("Molimo unesite obje adrese");const r=e(this);r.prop("disabled",!0).text("Izračunavam..."),e(".map-container").fadeOut(),e("#price-calculation-section").fadeOut(),e("#payment-section").fadeOut(),e("#cityride-message").empty().hide(),e("#booking-success").hide(),e.ajax({url:cityride_frontend_ajax.ajax_url,type:"POST",data:{action:"cityride_calculate_price",nonce:cityride_frontend_ajax.nonce,address_from:t,address_to:n},success:function(r){if(r.success){const s=r.data;i={address_from:t,address_to:n,distance_km:s.distance_km,total_price:s.total_price,start_tariff:s.start_tariff,price_per_km:s.price_per_km},e("#calculated_distance_km").val(s.distance_km),e("#calculated_total_price").val(s.total_price),e("#calculated_stripe_amount").val(s.stripe_amount),e("#distance-display").text(s.distance_km),e("#start-tariff-display").text(s.start_tariff.toFixed(2)),e("#price-per-km-display").text(s.price_per_km.toFixed(2)),e("#total-price").text(s.total_price.toFixed(2)),e("#discount-code-section").fadeIn(),e("#price-calculation-section").fadeIn(),s.route_geometry&&s.from_coords&&s.to_coords&&(!function(e,t,n){if(!cityride_frontend_ajax.mapbox_api_key)return void console.error("Mapbox API key is not defined.");const o=document.getElementById("cityride-map");o._mapboxMap&&o._mapboxMap.remove();mapboxgl.accessToken=cityride_frontend_ajax.mapbox_api_key;const a=new mapboxgl.Map({container:"cityride-map",style:"mapbox://styles/mapbox/streets-v11",center:[t.lng,t.lat],zoom:12});o._mapboxMap=a,a.on("load",function(){a.addSource("route",{type:"geojson",data:{type:"Feature",properties:{},geometry:e}}),a.addLayer({id:"route",type:"line",source:"route",layout:{"line-join":"round","line-cap":"round"},paint:{"line-color":"#3887be","line-width":5,"line-opacity":.75}}),new mapboxgl.Marker({color:"green"}).setLngLat([t.lng,t.lat]).setPopup((new mapboxgl.Popup).setHTML("<strong>Polazak</strong><br>"+i.address_from)).addTo(a),new mapboxgl.Marker({color:"red"}).setLngLat([n.lng,n.lat]).setPopup((new mapboxgl.Popup).setHTML("<strong>Odredište</strong><br>"+i.address_to)).addTo(a);const o=new mapboxgl.LngLatBounds;o.extend([t.lng,t.lat]),o.extend([n.lng,n.lat]),a.fitBounds(o,{padding:50})})}(s.route_geometry,s.from_coords,s.to_coords),e(".map-container").fadeIn()),e("#payment-section").fadeIn(),o&&!a&&(o.mount("#stripe-card-element"),a=!0),e("html, body").animate({scrollTop:e("#payment-section").offset().top-100},500)}else e("#cityride-message").text("Greška: "+r.data).css("color","red").fadeIn()},error:function(){e("#cityride-message").text("Greška pri povezivanju s serverom.").css("color","red").fadeIn()},complete:function(){r.prop("disabled",!1).text("Izračunaj Cijenu")}})}),e("#complete-payment-btn").on("click",function(){if(!t||!o)return void e("#cityride-message").text("Stripe nije pravilno učitan. Molimo osvježite stranicu.").css("color","red").fadeIn();const n=e(this);n.prop("disabled",!0).text("Obrađujem plaćanje..."),e("#stripe-card-errors").text("");const a=e("#passenger-name").val().trim(),r=e("#passenger-phone").val().trim(),s=e("#passenger-email").val()?.trim()||"";if(!a||!r)return e("#cityride-message").text("Molimo unesite Vaše ime i telefon.").css("color","red").fadeIn(),void n.prop("disabled",!1).text("Pozovi taxi");if(!i.total_price)return e("#cityride-message").text("Prvo izračunajte cijenu vožnje.").css("color","red").fadeIn(),void n.prop("disabled",!1).text("Pozovi taxi");const c=e("#passenger_onesignal_id").val();console.log("frontend-script.js: Slanje Passenger OneSignal ID-a u AJAX (create_payment_intent):",c);const l={action:"cityride_create_payment_intent",nonce:cityride_frontend_ajax.nonce,amount:Math.round(100*i.total_price),address_from:i.address_from,address_to:i.address_to,distance_km:i.distance_km,passenger_name:a,passenger_phone:r,passenger_email:s,passenger_onesignal_id:c};e.ajax({url:cityride_frontend_ajax.ajax_url,type:"POST",data:l,success:function(a){a.success?t.confirmCardPayment(a.data.client_secret,{payment_method:{card:o,billing_details:{name:l.passenger_name,phone:l.passenger_phone,email:l.passenger_email}}}).then(function(t){t.error?(e("#stripe-card-errors").text(t.error.message),n.prop("disabled",!1).text("Pozovi taxi")):function(t,n){const o=e("#passenger_onesignal_id").val();console.log("frontend-script.js: Slanje Passenger OneSignal ID-a u AJAX (save_booking):",o),e.ajax({url:cityride_frontend_ajax.ajax_url,type:"POST",data:{action:"cityride_save_booking",nonce:cityride_frontend_ajax.nonce,payment_intent_id:t,address_from:i.address_from,address_to:i.address_to,distance_km:i.distance_km,total_price:i.total_price,passenger_name:n.passenger_name,passenger_phone:n.passenger_phone,passenger_email:n.passenger_email,passenger_onesignal_id:o,discount_code:d?d.code:"",discount_amount:d?d.discount_amount:0,original_price:d?d.original_price:i.total_price,final_price:d?d.final_price:i.total_price},success:function(t){t.success?(e("#booking-id").text("#"+t.data.booking_id),e("#cityride-booking-form").hide(),e("#payment-section").hide(),e("#booking-success").fadeIn(),e("html, body").animate({scrollTop:e("#booking-success").offset().top-100},500)):e("#cityride-message").text("Greška pri spremanju rezervacije: "+t.data).css("color","red").fadeIn()},error:function(){e("#cityride-message").text("Greška pri spremanju rezervacije.").css("color","red").fadeIn()},complete:function(){e("#complete-payment-btn").prop("disabled",!1).text("Pozovi taxi")}})}(t.paymentIntent.id,l)}):(e("#cityride-message").text("Greška pri kreiranju plaćanja: "+a.data).css("color","red").fadeIn(),n.prop("disabled",!1).text("Pozovi taxi"))},error:function(){e("#cityride-message").text("Greška pri povezivanju s serverom.").css("color","red").fadeIn()},complete:function(){n.prop("disabled",!1).text("Pozovi taxi")}})}),o&&o.on("change",function(e){document.getElementById("stripe-card-errors").textContent=e.error?e.error.message:""});let s=!1,d=null;document.getElementById("discount-code-section");const c=document.getElementById("discount-code-input"),l=document.getElementById("apply-discount-btn"),p=document.getElementById("remove-discount-btn"),u=document.getElementById("discount-message"),_=document.getElementById("discount-details");function m(e,t){if(!e)return u.textContent="",void(u.style.display="none");u.textContent=e,u.style.display="block","success"===t?u.style.color="#4CAF50":"error"===t&&(u.style.color="#f44336")}l&&l.addEventListener("click",function(){const e=c.value.trim().toUpperCase();if(!e)return void m("Molimo unesite kod popusta.","error");const t=parseFloat(document.getElementById("calculated_total_price").value);l.disabled=!0,l.textContent="Provjeravam...",jQuery.ajax({url:cityride_frontend_ajax.ajax_url,type:"POST",data:{action:"cityride_validate_discount_code",nonce:cityride_frontend_ajax.nonce,code:e,order_amount:t},success:function(e){l.disabled=!1,l.textContent="Primijeni",e.success?(s=!0,d=e.data,document.getElementById("calculated_stripe_amount").value=d.stripe_amount,document.getElementById("discount_code_applied").value=d.code,document.getElementById("discount_amount_applied").value=d.discount_amount,document.getElementById("discount-original-price").textContent=d.original_price.toFixed(2)+" BAM",document.getElementById("discount-code-used").textContent=d.code,document.getElementById("discount-amount").textContent="-"+d.discount_amount.toFixed(2)+" BAM",document.getElementById("discount-final-price").textContent=d.final_price.toFixed(2)+" BAM",document.getElementById("total-price").textContent=d.final_price.toFixed(2),c.style.display="none",l.style.display="none",_.style.display="block",m(d.message,"success")):m(e.data,"error")},error:function(){l.disabled=!1,l.textContent="Primijeni",m("Greška pri validaciji koda. Pokušajte ponovo.","error")}})}),p&&p.addEventListener("click",function(){s=!1,d=null;const e=parseFloat(_.querySelector("#discount-original-price").textContent),t=Math.round(100*e);document.getElementById("calculated_stripe_amount").value=t,document.getElementById("discount_code_applied").value="",document.getElementById("discount_amount_applied").value="0",document.getElementById("total-price").textContent=e.toFixed(2),c.style.display="block",l.style.display="inline-block",_.style.display="none",c.value="",m("","")}),document.getElementById("calculate-price-btn").addEventListener("click",function(){s&&p.click()})});